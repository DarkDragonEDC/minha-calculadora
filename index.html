<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora de XP — Multiprofissão</title>
<link rel="icon" href="" />
<style>
  :root{
    --bg:#f3f6fb;
    --panel:#0f1724;
    --muted:#9aa3b2;
    --accent:#7c3aed;
    --card:#0b1220;
    --card-2:#111827;
    --glass: rgba(255,255,255,0.03);
    --success:#10b981;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: linear-gradient(180deg,#071124 0%, #081424 60%);
    color:#e6eef8;
    padding:18px;
    -webkit-font-smoothing:antialiased;
  }

  .wrap{
    max-width:980px;
    margin:18px auto;
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:18px;
  }

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:18px;
    box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    border:1px solid rgba(255,255,255,0.03);
  }

  header.card h1{
    margin:0 0 6px 0;
    font-size:1.15rem;
    letter-spacing:0.2px;
  }
  header.card p{margin:0;color:var(--muted);font-size:0.9rem}

  label{display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#dbeafe}
  select,input[type="number"]{
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.04);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    color: #e6eef8;
    font-size:0.95rem;
    outline:none;
  }
  .form-row{margin-bottom:12px}

  button.primary{
    width:100%;
    background:linear-gradient(180deg,var(--accent), #5b21b6);
    color:white;
    padding:12px;
    border-radius:10px;
    border:0;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 8px 18px rgba(124,58,237,0.18);
  }
  button.primary:active{transform:translateY(1px)}
  .small{font-size:0.85rem;color:var(--muted)}

  /* right column results */
  .results{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .result-block{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:14px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.02);
  }
  .result-block h3{margin:0 0 8px 0;font-size:1rem}
  .result-block p{margin:6px 0;color:#dbeafe}
  .muted{color:var(--muted);font-size:0.9rem}

  .grid-two{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  .credits{margin-top:8px;text-align:center;color:var(--muted);font-size:0.85rem}

  /* responsive */
  @media (max-width:980px){
    .wrap{grid-template-columns:1fr; padding-bottom:18px}
  }
  /* tiny touches */
  .small-muted{color:var(--muted);font-size:0.85rem}
  .highlight{color:var(--accent);font-weight:800}
  .pill{display:inline-block;background:var(--glass);padding:6px 10px;border-radius:999px;font-size:0.85rem}
  ul{padding-left:16px;margin:6px 0}
</style>
</head>
<body>
  <main class="wrap">
    <section class="card" aria-labelledby="title">
      <header>
        <h1 id="title">XP CALCULATOR — Multiprofissão</h1>
        <p class="small-muted">Escolha a profissão, item e calcule quanto falta e quanto vai gastar.</p>
      </header>

      <div style="margin-top:14px">
        <div class="form-row">
          <label for="profSelect">Profissão</label>
          <select id="profSelect" aria-label="Profissão"></select>
        </div>

        <div class="grid-two">
          <div class="form-row">
            <label for="currentXp">XP atual</label>
            <input id="currentXp" type="number" min="0" value="0" oninput="updateItemList()" aria-label="XP atual">
          </div>

          <div class="form-row">
            <label for="targetLvl">Nível alvo</label>
            <input id="targetLvl" type="number" min="1" value="1" aria-label="Nível alvo">
          </div>
        </div>

        <div class="grid-two">
          <div class="form-row">
            <label for="efficiency">Eficiência (%)</label>
            <input id="efficiency" type="number" min="0" max="99" value="0" aria-label="Eficiência">
          </div>

          <div class="form-row">
            <label for="itemSelect">Item (disponível no seu nível)</label>
            <select id="itemSelect" aria-label="Item"></select>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <button class="primary" onclick="calculate()">Calcular</button>
        </div>

        <div class="credits">
          <div>Discord: <span class="pill">darkdragonx3985</span></div>
        </div>

        <div style="margin-top:12px">
          <form class="paypal-donate-btn" action="https://www.paypal.com/donate" method="post" target="_top">
            <input type="hidden" name="business" value="JQSHTGU3WZA5Y" />
            <input type="hidden" name="no_recurring" value="0" />
            <input type="hidden" name="currency_code" value="BRL" />
            <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" border="0" name="submit" title="Doar via PayPal" alt="Doar com PayPal" />
            <img alt="" border="0" src="https://www.paypal.com/en_BR/i/scr/pixel.gif" width="1" height="1" />
          </form>
        </div>
      </div>
    </section>

    <aside class="card results" aria-live="polite">
      <div class="result-block">
        <h3>Resumo</h3>
        <p id="summaryXp" class="muted">Preencha e clique em <strong>Calcular</strong>.</p>
        <p id="summaryMore" class="muted" style="margin-top:8px"></p>
      </div>

      <div id="timeBlock" class="result-block" style="display:none">
        <h3>Tempo de criação</h3>
        <div id="timeList" class="muted"></div>
      </div>

      <div id="subcraftBlock" class="result-block" style="display:none">
        <h3>Sub-itens (crafts)</h3>
        <div id="subList" class="muted"></div>
      </div>

      <div id="rawBlock" class="result-block" style="display:none">
        <h3>Materiais básicos</h3>
        <div id="rawList" class="muted"></div>
      </div>
    </aside>
  </main>

  <!-- Dados dos itens — mantenha o seu arquivo externo -->
  <script src="./itensimport.js"></script>

  <script>
    // --- dados de nível (mantive a sua tabela) ---
    const XP_PER_LEVEL = [
      0, 84, 192, 324, 480, 645, 820, 1005, 1200, 1407, 1735, 2082, 2449, 2838, 3249, 3684, 4144, 4631, 5146, 5691, 6460, 7281, 8160, 9101, 10109, 11191, 12353, 13603, 14949, 16400, 18455, 20675, 23076, 25675, 28492, 31549, 34870, 38482, 42415, 46702, 52583, 58662, 64933, 71390, 78026, 84833, 91802, 98923, 106186, 114398, 123502, 132734, 142077, 151515, 161029, 170602, 180216, 189852, 199491, 209115, 220417, 232945, 246859, 262341, 279598, 298871, 320434, 344603, 371744, 402278, 441971, 486789, 537487, 594941, 660170, 734360, 818896, 915396, 1025752, 1152182, 1316749, 1492835, 1681248, 1882849, 2098562, 2329375, 2576345, 2840603, 3123359, 3425908, 3749636, 4269287, 4827911, 5428432, 6073992, 6767969, 7513995, 8315973, 9178099
    ];

    // util
    function formatNumber(n){ return (typeof n === 'number') ? n.toLocaleString('pt-BR') : n; }

    function getLevelFromXp(xp){
      let currentLevel = 1;
      for (let i = 0; i < XP_PER_LEVEL.length; i++){
        if (xp >= XP_PER_LEVEL[i]) currentLevel = i + 1;
      }
      return currentLevel;
    }

    // elementos
    const profSelect = document.getElementById('profSelect');
    const itemSelect = document.getElementById('itemSelect');
    const currentXpInput = document.getElementById('currentXp');
    const resultsSummary = document.getElementById('summaryXp');
    const resultsMore = document.getElementById('summaryMore');
    const timeBlock = document.getElementById('timeBlock');
    const timeList = document.getElementById('timeList');
    const subcraftBlock = document.getElementById('subcraftBlock');
    const subList = document.getElementById('subList');
    const rawBlock = document.getElementById('rawBlock');
    const rawList = document.getElementById('rawList');

    // Popula profissões quando allData carregado
    function populateProfessions(){
      if(typeof allData !== 'object'){
        profSelect.innerHTML = '<option disabled>Dados não encontrados (itensimport.js)</option>';
        return;
      }
      profSelect.innerHTML = '';
      for (const prof in allData){
        const opt = document.createElement('option');
        opt.value = prof;
        opt.textContent = prof.charAt(0).toUpperCase() + prof.slice(1);
        profSelect.appendChild(opt);
      }
      updateItemList();
    }

    // atualiza lista de itens com base no nível atual do usuário
    function updateItemList(){
      const selectedProf = profSelect.value;
      const currentXp = parseInt(currentXpInput.value) || 0;
      const currentLevel = getLevelFromXp(currentXp);

      itemSelect.innerHTML = '';
      const items = (allData && allData[selectedProf]) ? allData[selectedProf] : [];

      const filtered = items.filter(it => (typeof it.Level === 'number') ? it.Level <= currentLevel : true);

      if(filtered.length){
        filtered.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.Name;
          opt.textContent = `(Lvl ${item.Level}) ${item.Name}`;
          itemSelect.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = 'Nenhum item disponível para este nível';
        opt.disabled = true;
        itemSelect.appendChild(opt);
      }
    }

    // conversão de tempo do formato "X s" / "X m" / "X h" para segundos
    function parseTime(timeString){
      if(!timeString) return 0;
      // formatos como "10 s", "2 m", "1 h", "1 d" ou "1 month", etc
      const s = String(timeString).trim();
      const match = s.match(/^(\d+)\s*(s|sec|second|m|min|minute|h|hour|d|day|mo|month|y|year)/i);
      if(!match) return parseInt(s) || 0;
      const val = parseInt(match[1],10);
      const unit = match[2].toLowerCase();
      switch(unit){
        case 's': case 'sec': case 'second': return val;
        case 'm': case 'min': case 'minute': return val * 60;
        case 'h': case 'hour': return val * 3600;
        case 'd': case 'day': return val * 86400;
        case 'mo': case 'month': case 'month(s)': return val * 2592000;
        case 'y': case 'year': return val * 31536000;
        default: return val;
      }
    }

    function formatTime(totalSeconds){
      if(totalSeconds <= 0) return '0s';
      totalSeconds = Math.round(totalSeconds);
      const years = Math.floor(totalSeconds / 31536000); totalSeconds %= 31536000;
      const months = Math.floor(totalSeconds / 2592000); totalSeconds %= 2592000;
      const days = Math.floor(totalSeconds / 86400); totalSeconds %= 86400;
      const hours = Math.floor(totalSeconds / 3600); totalSeconds %= 3600;
      const minutes = Math.floor(totalSeconds / 60); const seconds = totalSeconds % 60;
      const parts = [];
      if(years) parts.push(years + 'y');
      if(months) parts.push(months + 'mo');
      if(days) parts.push(days + 'd');
      if(hours) parts.push(hours + 'h');
      if(minutes) parts.push(minutes + 'm');
      if(seconds) parts.push(seconds + 's');
      return parts.join(' ');
    }

    // cálculo recursivo: retorna materias brutas, subcrafts, tempo e xp
    function calculateDetails(profKey, itemName, craftsNeeded, efficiencyPercent){
      const profItems = allData[profKey];
      const item = profItems.find(i => i.Name === itemName);
      if(!item) return { rawMaterials:{}, subCrafts:{}, totalTime:0, totalXp:0 };

      const rawMaterials = {};
      const subCrafts = {};
      let totalTime = 0;
      let totalXp = 0;

      const baseTime = parseTime(item['Base Time']);
      const effectiveTime = baseTime * (1 - (efficiencyPercent || 0)/100);
      totalTime += effectiveTime * craftsNeeded;
      totalXp += (Number(item['Skill Exp']) || 0) * craftsNeeded;

      // percorre requisitos (até 4)
      for(let i=1;i<=4;i++){
        const reqName = item[`Requirement ${i}`];
        const reqAmount = Number(item[`Requirement ${i} Amount`]) || 0;
        if(reqName && reqAmount){
          // se o requisito é um craft dentro da mesma profissão
          const isSub = profItems.some(pi => pi.Name === reqName);
          if(isSub){
            subCrafts[reqName] = (subCrafts[reqName] || 0) + reqAmount * craftsNeeded;
            // calcula recursivamente
            const subResult = calculateDetails(profKey, reqName, reqAmount * craftsNeeded, efficiencyPercent);
            // agrega
            totalTime += subResult.totalTime;
            totalXp += subResult.totalXp;
            for(const m in subResult.rawMaterials) rawMaterials[m] = (rawMaterials[m]||0) + subResult.rawMaterials[m];
            for(const s in subResult.subCrafts) subCrafts[s] = (subCrafts[s]||0) + subResult.subCrafts[s];
          } else {
            rawMaterials[reqName] = (rawMaterials[reqName]||0) + reqAmount * craftsNeeded;
          }
        }
      }

      return { rawMaterials, subCrafts, totalTime, totalXp };
    }

    function calculate(){
      // leituras
      const currentXp = parseInt(document.getElementById('currentXp').value) || 0;
      const targetLvl = parseInt(document.getElementById('targetLvl').value) || 1;
      const efficiency = parseFloat(document.getElementById('efficiency').value) || 0;
      const profKey = profSelect.value;
      const itemName = itemSelect.value;

      // validações básicas
      if(!profKey || !allData || !allData[profKey]){
        resultsSummary.textContent = 'Profissão inválida ou dados não carregados.';
        return;
      }
      if(targetLvl < 1 || targetLvl > XP_PER_LEVEL.length){
        resultsSummary.innerHTML = `Nível alvo inválido. (1 - ${XP_PER_LEVEL.length})`;
        return;
      }

      const targetXp = XP_PER_LEVEL[targetLvl - 1];
      if(targetXp <= currentXp){
        resultsSummary.innerHTML = `Você já tem XP suficiente para o nível ${targetLvl}.`;
        timeBlock.style.display = 'none'; subcraftBlock.style.display='none'; rawBlock.style.display='none';
        return;
      }

      const xpNeeded = targetXp - currentXp;

      const profItems = allData[profKey];
      const selectedItem = profItems.find(i => i.Name === itemName);
      if(!selectedItem){
        resultsSummary.textContent = 'Item inválido.';
        return;
      }

      // Primeiro calcula os detalhes para 1 unidade (incluindo subcrafts)
      const singleDetail = calculateDetails(profKey, itemName, 1, efficiency);
      if(singleDetail.totalXp <= 0){
        resultsSummary.textContent = 'XP por item é zero — verifique os dados do item.';
        return;
      }

      const craftsNeeded = Math.ceil(xpNeeded / singleDetail.totalXp);
      // Recalcula tudo multiplicado pela quantidade final
      const finalDetail = calculateDetails(profKey, itemName, craftsNeeded, efficiency);

      const totalXpFinal = finalDetail.totalXp;
      const totalTimeFinal = finalDetail.totalTime;
      // agrega finais
      const finalRaw = finalDetail.rawMaterials;
      const finalSubs = finalDetail.subCrafts;

      // monta saída
      resultsSummary.innerHTML = `<strong>XP faltante:</strong> ${formatNumber(xpNeeded)} — <strong>Itens necessários:</strong> ${formatNumber(craftsNeeded)} x ${itemName} (cada um dá ${formatNumber(singleDetail.totalXp)} XP)`;
      resultsMore.innerHTML = `<span class="small-muted">Nível atual estimado: ${getLevelFromXp(currentXp)} — Nível alvo: ${targetLvl}</span>`;

      // tempo
      timeBlock.style.display = 'block';
      timeList.innerHTML = `<p><strong>Tempo total estimado:</strong> ${formatTime(totalTimeFinal)}</p>`;

      // detalhe por sub-item
      const subsKeys = Object.keys(finalSubs).sort();
      if(subsKeys.length){
        subcraftBlock.style.display = 'block';
        subList.innerHTML = subsKeys.map(k => `<p>${k}: ${formatNumber(finalSubs[k])}</p>`).join('');
      } else {
        subcraftBlock.style.display = 'none';
        subList.innerHTML = '';
      }

      // materias cruas
      const matsKeys = Object.keys(finalRaw).sort();
      if(matsKeys.length){
        rawBlock.style.display = 'block';
        rawList.innerHTML = matsKeys.map(k => `<p>${k}: ${formatNumber(finalRaw[k])}</p>`).join('');
      } else {
        rawBlock.style.display = 'none';
        rawList.innerHTML = '';
      }
    }

    // eventos
    profSelect.addEventListener('change', updateItemList);
    currentXpInput.addEventListener('change', updateItemList);

    // quando o allData estiver disponível (itensimport.js carrega antes deste script),
    // popula profissões. Se itensimport carregar depois, tenta novamente.
    function tryPopulate(retries=0){
      if(typeof allData === 'object'){
        populateProfessions();
      } else if(retries < 20){
        setTimeout(()=>tryPopulate(retries+1), 100);
      } else {
        profSelect.innerHTML = '<option disabled>Não foi possível carregar dados</option>';
      }
    }
    tryPopulate();
  </script>
</body>
</html>

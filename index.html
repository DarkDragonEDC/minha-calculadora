<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XP CALCULATOR</title>
<style>
  :root{
    --bg:#f3f6fb;
    --panel:#0f1724;
    --muted:#9aa3b2;
    --accent:#7c3aed;
    --glass: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: linear-gradient(180deg,#071124 0%, #081424 60%);
    color:#e6eef8;
    padding:18px;
    -webkit-font-smoothing:antialiased;
    text-align: center;
  }

  .wrap{
    max-width:980px;
    margin:18px auto;
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:18px;
  }

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:18px;
    box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    border:1px solid rgba(255,255,255,0.03);
    text-align: center;
  }

  header.card h1{
    margin:0 0 6px 0;
    font-size:1.15rem;
    letter-spacing:0.2px;
  }
  header.card p{margin:0;color:var(--muted);font-size:0.9rem}

  label{display:block;margin-bottom:6px;font-weight:600;font-size:0.9rem;color:#dbeafe}
  select,input[type="number"]{
    width:100%;
    padding:10px 12px;
    border-radius:8px;
    border:1px solid rgba(255,255,255,0.04);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    color: #e6eef8;
    font-size:0.95rem;
    outline:none;
    text-align: center;
  }
  select option {
    color: var(--panel);
    background: var(--bg);
  }
  
  input::placeholder {
    color: var(--muted);
    opacity: 0.6;
    text-align: center;
  }

  .form-row{margin-bottom:12px}

  button.primary{
    width:100%;
    background:linear-gradient(180deg,var(--accent), #5b21b6);
    color:white;
    padding:12px;
    border-radius:10px;
    border:0;
    font-weight:700;
    cursor:pointer;
    box-shadow:0 8px 18px rgba(124,58,237,0.18);
  }
  button.primary:active{transform:translateY(1px)}
  .small{font-size:0.85rem;color:var(--muted)}

  .results{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .result-block{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:14px;
    border-radius:10px;
    border:1px solid rgba(255,255,255,0.02);
  }
  .result-block h3{margin:0 0 8px 0;font-size:1rem}
  .result-block p{margin:6px 0;color:#dbeafe}
  .muted{color:var(--muted);font-size:0.9rem}

  .grid-two{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  .grid-two--compact{
    grid-template-columns: 0.55fr 1.45fr;
    gap:10px;
  }

  .credits{margin-top:8px;text-align:center;color:var(--muted);font-size:0.85rem}

  /* MEDIA QUERIES para responsividade */
  @media (max-width: 980px) {
    .wrap {
      grid-template-columns: 1fr; /* Muda para uma única coluna */
    }
  }

  @media (max-width: 500px) {
    body {
      padding: 12px;
    }
    .grid-two,
    .grid-two--compact {
      grid-template-columns: 1fr; /* Muda os grids internos para uma única coluna */
    }
    .card {
      padding: 12px;
    }
  }

  .small-muted{color:var(--muted);font-size:0.85rem}
  .pill{display:inline-block;background:var(--glass);padding:6px 10px;border-radius:999px;font-size:0.85rem}
  .donate-wrap{text-align:center;margin-top:8px;}
</style>
</head>
<body>
  <main class="wrap">
    <section class="card" aria-labelledby="title">
      <header>
        <h1 id="title">XP CALCULATOR</h1>
        <p class="small-muted">Choose profession, item and calculate how much XP and resources you need.</p>
      </header>

      <div style="margin-top:14px">
        <div class="form-row">
          <label for="profSelect">Profession</label>
          <select id="profSelect" aria-label="Profession"></select>
        </div>

        <div class="grid-two">
          <div class="form-row">
            <label for="currentXp">Current XP</label>
            <input id="currentXp" type="number" min="0" value="" placeholder="Enter your current XP" oninput="updateItemList()" aria-label="Current XP">
          </div>

          <div class="form-row">
            <label for="targetLvl">Target Level</label>
            <input id="targetLvl" type="number" min="1" value="" placeholder="Enter the desired lvl" aria-label="Target Level">
          </div>
        </div>

        <div class="grid-two grid-two--compact">
          <div class="form-row">
            <label for="efficiency">Efficiency (%)</label>
            <input id="efficiency" type="number" min="0" max="99" value="" placeholder="Ur total Eff" aria-label="Efficiency">
          </div>

          <div class="form-row">
            <label for="itemSelect">Item</label>
            <select id="itemSelect" aria-label="Item"></select>
          </div>
        </div>

        <div style="display:flex;gap:10px;align-items:center">
          <button class="primary" onclick="calculate()">Calculate</button>
        </div>

        <div class="credits">
          <div>Discord: <span class="pill">darkdragonx3985</span></div>
        </div>

        <div class="donate-wrap">
          <form class="paypal-donate-btn" action="https://www.paypal.com/donate" method="post" target="_top" style="display:inline-block;text-align:center">
            <input type="hidden" name="business" value="JQSHTGU3WZA5Y" />
            <input type="hidden" name="no_recurring" value="0" />
            <input type="hidden" name="currency_code" value="BRL" />
            <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif" border="0" name="submit" title="Donate with PayPal" alt="Donate with PayPal" />
            <img alt="" border="0" src="https://www.paypal.com/en_BR/i/scr/pixel.gif" width="1" height="1" />
          </form>
        </div>

      </div>
    </section>

    <aside class="card results" aria-live="polite">
      <div class="result-block">
        <h3>Summary</h3>
        <p id="summaryXp" class="muted">Fill the fields and click <strong>Calculate</strong>.</p>
        <p id="summaryMore" class="muted" style="margin-top:8px"></p>
      </div>

      <div id="timeBlock" class="result-block" style="display:none">
        <h3>Crafting Time</h3>
        <div id="timeList" class="muted"></div>
      </div>

      <div id="subcraftBlock" class="result-block" style="display:none">
        <h3>Sub-items (crafts)</h3>
        <div id="subList" class="muted"></div>
      </div>

      <div id="rawBlock" class="result-block" style="display:none">
        <h3>Raw Materials</h3>
        <div id="rawList" class="muted"></div>
      </div>
    </aside>
  </main>

  <script src="./craftsimport.js"></script>

  <script>
    // Level XP table
    const XP_PER_LEVEL = [
      0,84,192,324,480,645,820,1005,1200,1407,1735,2082,2449,2838,3249,3684,4144,4631,5146,5691,6460,7281,8160,9101,10109,11191,12353,13603,14949,16400,18455,20675,23076,25675,28492,31549,34870,38482,42415,46702,52583,58662,64933,71390,78026,84833,91802,98923,106186,114398,123502,132734,142077,151515,161029,170602,180216,189852,199491,209115,220417,232945,246859,262341,279598,298871,320434,344603,371744,402278,441971,486789,537487,594941,660170,734360,818896,915396,1025752,1152182,1316749,1492835,1681248,1882849,2098562,2329375,2576345,2840603,3123359,3425908,3749636,4269287,4827911,5428432,6073992,6767969,7513995,8315973,9178099
    ];

    function formatNumber(n){ return (typeof n === 'number') ? n.toLocaleString('en-US') : n; }

    function getLevelFromXp(xp){
      let currentLevel = 1;
      for (let i = 0; i < XP_PER_LEVEL.length; i++){
        if (xp >= XP_PER_LEVEL[i]) currentLevel = i + 1;
      }
      return currentLevel;
    }

    const profSelect = document.getElementById('profSelect');
    const itemSelect = document.getElementById('itemSelect');
    const currentXpInput = document.getElementById('currentXp');
    const resultsSummary = document.getElementById('summaryXp');
    const resultsMore = document.getElementById('summaryMore');
    const timeBlock = document.getElementById('timeBlock');
    const timeList = document.getElementById('timeList');
    const subcraftBlock = document.getElementById('subcraftBlock');
    const subList = document.getElementById('subList');
    const rawBlock = document.getElementById('rawBlock');
    const rawList = document.getElementById('rawList');
    const gatheringProfessions = ['Woodcutting', 'Mining', 'Fishing', 'Herbalism', 'Tracking', 'Gathering'];

    function populateProfessions() {
      if (typeof allData !== 'object') {
        profSelect.innerHTML = '<option disabled>Data not found (craftsimport.js)</option>';
        return;
      }
      profSelect.innerHTML = '';
      const allProfessions = [];
    
      for (const category in allData) {
        if (typeof allData[category] === 'object' && !Array.isArray(allData[category])) {
          for (const profession in allData[category]) {
            allProfessions.push(profession);
          }
        } else {
          allProfessions.push(category);
        }
      }
    
      allProfessions.forEach(prof => {
        const option = document.createElement('option');
        option.value = prof;
        option.textContent = prof.charAt(0).toUpperCase() + prof.slice(1);
        profSelect.appendChild(option);
      });
      
      updateItemList();
    }
    
    function getNumericLevel(level) {
        if (typeof level === 'number') {
            return level;
        }
        if (typeof level === 'string') {
            const tier = level.toUpperCase();
            if (tier === 'T1') return 85;
            if (tier === 'T2') return 90;
            if (tier === 'T3') return 95;
        }
        return Number.MAX_SAFE_INTEGER;
    }

    function updateItemList(){
      const selectedProf = profSelect.value;
      const currentXp = parseInt(currentXpInput.value) || 0;
      const currentLevel = getLevelFromXp(currentXp);
    
      itemSelect.innerHTML = '';
      let items = [];
    
      for (const category in allData) {
        if (typeof allData[category] === 'object' && !Array.isArray(allData[category])) {
          if (allData[category][selectedProf]) {
            items = allData[category][selectedProf];
            break;
          }
        } else {
          if (category === selectedProf) {
            items = allData[category];
            break;
          }
        }
      }
    
      const filtered = items.filter(it => getNumericLevel(it.Level) <= currentLevel);
    
      if(filtered.length){
        filtered.forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.Name;
          
          let levelText = `(Lvl ${item.Level})`;
          if (item.Level === 'T1' || item.Level === 'T2' || item.Level === 'T3') {
              levelText = `(${item.Level})`;
          }
          opt.textContent = `${levelText} ${item.Name}`;
          itemSelect.appendChild(opt);
        });
      } else {
        const opt = document.createElement('option');
        opt.textContent = 'No items available at this level';
        opt.disabled = true;
        itemSelect.appendChild(opt);
      }
    }

    function parseTime(timeString){
      if(!timeString) return 0;
      const s = String(timeString).trim();
      const match = s.match(/^(\d+)\s*(s|sec|second|m|min|minute|h|hour|d|day|mo|month|y|year)/i);
      if(!match) return parseInt(s) || 0;
      const val = parseInt(match[1],10);
      const unit = match[2].toLowerCase();
      switch(unit){
        case 's': case 'sec': case 'second': return val;
        case 'm': case 'min': case 'minute': return val * 60;
        case 'h': case 'hour': return val * 3600;
        case 'd': case 'day': return val * 86400;
        case 'mo': case 'month': return val * 2592000;
        case 'y': case 'year': return val * 31536000;
        default: return val;
      }
    }

    function formatTime(totalSeconds){
      if(totalSeconds <= 0) return '0s';
      totalSeconds = Math.round(totalSeconds);
      const years = Math.floor(totalSeconds / 31536000); totalSeconds %= 31536000;
      const months = Math.floor(totalSeconds / 2592000); totalSeconds %= 2592000;
      const days = Math.floor(totalSeconds / 86400); totalSeconds %= 86400;
      const hours = Math.floor(totalSeconds / 3600); totalSeconds %= 3600;
      const minutes = Math.floor(totalSeconds / 60); const seconds = totalSeconds % 60;
      const parts = [];
      if(years) parts.push(years + 'y');
      if(months) parts.push(months + 'mo');
      if(days) parts.push(days + 'd');
      if(hours) parts.push(hours + 'h');
      if(minutes) parts.push(minutes + 'm');
      if(seconds) parts.push(seconds + 's');
      return parts.join(' ');
    }

    function getItemProfession(itemName) {
        for (const category in allData) {
            if (typeof allData[category] === 'object' && !Array.isArray(allData[category])) {
              for (const subProf in allData[category]) {
                if (allData[category][subProf].some(i => i.Name === itemName)) {
                  return subProf;
                }
              }
            } else {
              if (allData[category].some(i => i.Name === itemName)) {
                return category;
              }
            }
        }
        return null;
    }
    
    // Recursive function to calculate all details and times
    function calculateDetails(profKey, itemName, craftsNeeded, efficiencyPercent){
        let profItems = null;
        for (const category in allData) {
            if (typeof allData[category] === 'object' && !Array.isArray(allData[category])) {
                if (allData[category][profKey]) {
                    profItems = allData[category][profKey];
                    break;
                }
            } else {
                if (category === profKey) {
                    profItems = allData[category];
                    break;
                }
            }
        }

        if(!profItems) return { rawMaterials:{}, subCrafts:{}, craftingTimes:{}, totalTime:0, totalXp:0 };
        
        const item = profItems.find(i => i.Name === itemName);
        if(!item) return { rawMaterials:{}, subCrafts:{}, craftingTimes:{}, totalTime:0, totalXp:0 };

        const rawMaterials = {};
        const subCrafts = {};
        const craftingTimes = {};
        let totalTime = 0;
        let totalXp = 0;

        // Check if the item gives XP to the main profession
        const itemProf = getItemProfession(itemName);
        if (itemProf === profKey) {
            const baseTime = parseTime(item['Base Time']);
            const effectiveTime = baseTime * (1 - (efficiencyPercent || 0) / 100);
            const thisItemTime = effectiveTime * craftsNeeded;
            craftingTimes[itemName] = thisItemTime;
            totalTime += thisItemTime;
            totalXp += (Number(item['Skill Exp']) || 0) * craftsNeeded;
        }
      
        for(let i = 0; i <= 10; i++){
          const reqName = item[`Requirement ${i}`];
          const reqAmount = Number(item[`Requirement ${i} Amount`]) || 0;
          if(reqName && reqAmount){
            const subProfKey = getItemProfession(reqName);
            
            if(subProfKey && !gatheringProfessions.includes(subProfKey)){
              // This is a craftable item, so we add it to sub-crafts
              subCrafts[reqName] = (subCrafts[reqName] || 0) + reqAmount * craftsNeeded;

              // Recursive call
              const subResult = calculateDetails(subProfKey, reqName, reqAmount * craftsNeeded, efficiencyPercent);
              
              // Only accumulate time and XP if it's from the SAME profession
              if (subProfKey === profKey) {
                  totalTime += subResult.totalTime;
                  totalXp += subResult.totalXp;
                  // Merge crafting times
                  for (const t in subResult.craftingTimes) {
                      craftingTimes[t] = (craftingTimes[t] || 0) + subResult.craftingTimes[t];
                  }
              }
              
              for(const m in subResult.rawMaterials) rawMaterials[m] = (rawMaterials[m] || 0) + subResult.rawMaterials[m];
              for(const s in subResult.subCrafts) subCrafts[s] = (subCrafts[s] || 0) + subResult.subCrafts[s];

            } else {
              // This is a raw material
              rawMaterials[reqName] = (rawMaterials[reqName] || 0) + reqAmount * craftsNeeded;
            }
          }
        }
        return { rawMaterials, subCrafts, craftingTimes, totalTime, totalXp };
    }


    function calculate(){
      const currentXp = parseInt(document.getElementById('currentXp').value) || 0;
      const targetLvl = parseInt(document.getElementById('targetLvl').value) || 1;
      const efficiency = parseFloat(document.getElementById('efficiency').value) || 0;
      const profKey = profSelect.value;
      const itemName = itemSelect.value;
      
      let profItems = null;
      for (const category in allData) {
          if (typeof allData[category] === 'object' && !Array.isArray(allData[category])) {
              if (allData[category][profKey]) {
                  profItems = allData[category][profKey];
                  break;
              }
          } else {
              if (category === profKey) {
                  profItems = allData[category];
                  break;
              }
          }
      }

      if(!profItems){
        resultsSummary.textContent = 'Invalid profession or data not loaded.';
        return;
      }
      if(targetLvl < 1 || targetLvl > XP_PER_LEVEL.length){
        resultsSummary.innerHTML = `Invalid target level. (1 - ${XP_PER_LEVEL.length})`;
        return;
      }

      const targetXp = XP_PER_LEVEL[targetLvl - 1];
      if(targetXp <= currentXp){
        resultsSummary.innerHTML = `You already have enough XP for level ${targetLvl}.`;
        timeBlock.style.display = 'none'; subcraftBlock.style.display='none'; rawBlock.style.display='none';
        return;
      }

      const selectedItem = profItems.find(i => i.Name === itemName);
      if(!selectedItem){
        resultsSummary.textContent = 'Invalid item.';
        return;
      }
      
      // Calculate the total XP for one full craft, including sub-items of the same profession
      const detailsForOneCraft = calculateDetails(profKey, itemName, 1, efficiency);
      const totalXpPerCraft = detailsForOneCraft.totalXp;
      
      if (totalXpPerCraft <= 0) {
        resultsSummary.textContent = 'XP per item is zero — check item data.';
        return;
      }
      
      const xpNeeded = targetXp - currentXp;
      
      // Calculate the number of crafts needed based on the total XP per craft
      const craftsNeeded = Math.ceil(xpNeeded / totalXpPerCraft);

      // Now, use this number of crafts to calculate everything else
      const finalDetail = calculateDetails(profKey, itemName, craftsNeeded, efficiency);

      const totalTimeFinal = finalDetail.totalTime;
      const finalRaw = finalDetail.rawMaterials;
      const finalSubs = finalDetail.subCrafts;
      const finalCraftingTimes = finalDetail.craftingTimes;

      const isMainItemCrafting = !gatheringProfessions.includes(profKey);

      resultsSummary.innerHTML = `<strong>XP needed:</strong> ${formatNumber(xpNeeded)}<br><strong>Items required:</strong> ${formatNumber(craftsNeeded)} x ${itemName}<br><span class="small-muted">(each gives ${formatNumber(totalXpPerCraft)} XP)</span>`;
      resultsMore.innerHTML = `<span class="small-muted">Estimated current level: ${getLevelFromXp(currentXp)} — Target level: ${targetLvl}</span>`;

      timeBlock.style.display = 'block';
      const timeBlockTitle = timeBlock.querySelector('h3');
      timeBlockTitle.textContent = isMainItemCrafting ? 'Crafting Time' : 'Gathering Time';
      
      let timeItemsHtml = '';
      const sortedTimeKeys = Object.keys(finalCraftingTimes).sort();
      sortedTimeKeys.forEach(item => {
          timeItemsHtml += `<p><strong>${item}:</strong> ${formatTime(finalCraftingTimes[item])}</p>`;
      });
      timeList.innerHTML = `${timeItemsHtml}<p><strong>Total estimated time:</strong> ${formatTime(totalTimeFinal)}</p>`;


      const subsKeys = Object.keys(finalSubs).sort();
      if(subsKeys.length){
        subcraftBlock.style.display = 'block';
        subList.innerHTML = subsKeys.map(k => `<p>${k}: ${formatNumber(finalSubs[k])}</p>`).join('');
      } else {
        subcraftBlock.style.display = 'none';
        subList.innerHTML = '';
      }

      const matsKeys = Object.keys(finalRaw).sort();
      if(matsKeys.length){
        rawBlock.style.display = 'block';
        rawList.innerHTML = matsKeys.map(k => `<p>${k}: ${formatNumber(finalRaw[k])}</p>`).join('');
      } else {
        rawBlock.style.display = 'none';
        rawList.innerHTML = '';
      }
    }

    profSelect.addEventListener('change', updateItemList);
    currentXpInput.addEventListener('change', updateItemList);

    function tryPopulate(retries=0){
      if(typeof allData === 'object'){
        populateProfessions();
      } else if(retries < 20){
        setTimeout(()=>tryPopulate(retries+1), 100);
      } else {
        profSelect.innerHTML = '<option disabled>Data failed to load</option>';
      }
    }
    tryPopulate();
  </script>
</body>
</html>